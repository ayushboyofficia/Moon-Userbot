from pyrogram import filters
from pyrogram.types import Message
from Moon import app

raid_status = {}  # Stores raid status for each chat

# Command to start/stop reply raid
@app.on_message(filters.command("replyraid") & filters.group)
async def toggle_reply_raid(_, message: Message):
    if not message.from_user:
        return
    
    # Check if user is admin
    admins = await app.get_chat_members(message.chat.id, filter="administrators")
    if message.from_user.id not in [admin.user.id for admin in admins]:
        await message.reply("**You need to be admin to use this!**")
        return
    
    # Get target user
    if not message.reply_to_message:
        await message.reply("**Reply to a user to start raid!**")
        return
    
    target = message.reply_to_message.from_user
    chat_id = message.chat.id
    
    # Toggle raid
    if chat_id in raid_status and raid_status[chat_id]["target"] == target.id:
        del raid_status[chat_id]
        await message.reply(f"**Reply raid stopped on {target.mention}!**")
    else:
        raid_status[chat_id] = {"target": target.id, "active": True}
        await message.reply(f"**Reply raid started on {target.mention}!**")

# Auto-reply to target user
@app.on_message(filters.group & ~filters.service)
async def auto_reply_raid(_, message: Message):
    chat_id = message.chat.id
    
    if chat_id not in raid_status or not raid_status[chat_id]["active"]:
        return
    
    target_id = raid_status[chat_id]["target"]
    
    if message.from_user and message.from_user.id == target_id:
        await message.reply("**RAIDED!** ğŸ”¥")
